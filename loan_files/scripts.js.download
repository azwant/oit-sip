$("document").ready(function()
{
	
	startForm();
	
	/*
	 * Operational categorization tier1
	 * 30 seconds timeout
	 */
	var tier1OC = $("#drpdwn-OCtier1").select2({
		minimumResultsForSearch: Infinity
	});
	
	$("#drpdwn-OCtier1").change(function()
	{
		clearStatusBox();
		
		var t1 = $(this).val();

		if (t1 > 0)
		{
			
			$.ajax({
				url: "/getcategories/" + t1,
				method : 'GET', 
				beforeSend: function(){
					$("#modal-container").show();
				},
				timeout: 120000, // 120s timeout
				error: function(){
					// will fire when timeout is reached
					$("#status-box div div").addClass('alert-danger');
					$("#status-box div div").html('Operational categorization timeout, refresh the page and please try again. <br>Contact the administrator if you keep getting this error.');
					
					$("#status-box").show();
					$("#modal-container").hide();
			    }
			})
			.done(function (data){
				var optItems = [];
				if(data.length>0){
					$.each(data, function(key, val) {
						optItems.push('<option value="'+val.name+'">'+val.name+'</option>');
					});
				}
				//create the tier1 select elements
				$("#drpdwn-OCtier2").html(optItems.join(''));
				//select the firt available
				$("#drpdwn-OCtier2").val($("#drpdwn-OCtier2 option:first").val());

				tier2OC.val($("#drpdwn-OCtier2 option:first").val()).trigger("change");
				
				updateSummary();
				$("#modal-container").hide();
			});
		}
		else
		{
			$("#drpdwn-product").html('<option value="">- Choose One -</option>');
			product.val($("#drpdwn-product option:first").val()).trigger("change");
			
			$("#drpdwn-OCtier2").html('<option value="">- Choose One -</option>');
			tier2OC.val($("#drpdwn-OCtier2 option:first").val()).trigger("change");
			
			updateSummary();
		}
	});

	/*
	 * Operational categorization tier2
	 * 
	 */

	var tier2OC = $("#drpdwn-OCtier2").select2({
		minimumResultsForSearch: Infinity
	});
	
	$("#drpdwn-OCtier2").change(function()
	{
		updateSummary();
	});

	/*
	 * Products select 
	 * 
	 */	
	var product = $("#drpdwn-product").select2(
	{
		ajax: {
			placeholder: 'Enter a product',
		    url: '/getproducts',
		    dataType: 'json',
		    delay: 400,
		    data: function(params) {
                return {
                    term: params.term
                }
            },
            processResults: function (data, page) {
                return {
                  results: data
                };
              },
		    cache: true
		},
		escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
		minimumInputLength: 2				 
	});

	$("#drpdwn-product").change(function()
	{
		updateSummary();
	});

	/*
	 * Customer 
	 * 30 seconds timeout
	 */
	$("#customersearch").click(function()
	{
		$.ajax({
			url: "/getcustomer/" + $("#txt-customer").val(),
			method : 'GET', 
			beforeSend: function(){
				$("#modal-container").show();
			},
			timeout: 120000, // 120s timeout
			error: function(){
		        // will fire when timeout is reached
				$("#customer-name div").removeClass('alert-success');	
				$("#customer-name div").html('Search timeout, please try again.');
				$("#customer-name div").addClass('alert-danger');
				$("#customer-name").show();
				$("#modal-container").hide();
		    }
		})		
		.done(function (data){

			if (!data.name)
			{
				$("#customer-name div").removeClass('alert-success');	
				$("#customer-name div").html(data.error);
				$("#customer-name div").addClass('alert-danger');					
			}
			else
			{
				$("#customer-name div").removeClass('alert-danger');	
				$("#customer-name div").html('<strong>GIN: </strong><span id="txt-gin">'+data.gin+'</span><br><strong>Name: </strong>' + data.name);
				$("#customer-name div").addClass('alert-success');
			}		

			$("#customer-name").show();	
			$("#modal-container").hide();

		});
		
	});
	
	$("#txt-customer").focus(function(){				
		clearCustomerBox();
	});
	
	/*
	 * Ticket creation
	 * 30 seconds timeout
	 */
	$("#btn-create").click(function (){

		clearStatusBox();
		
		var data = {
			customer_gin	: $("#txt-gin").html(),
			customer_alias	: $("#txt-customer").val(),
			OCtier1			: $("#drpdwn-OCtier1 option:selected").text(),
			OCtier2			: $("#drpdwn-OCtier2 option:selected").text(),
			product			: $("#drpdwn-product option:selected").text(),
			summary			: $("#txt-summary").val(),
			details			: $("#txt-details").val()
		}
		
		var missing = "";
		
		if ((data.customer_gin == "") || (data.customer_gin == undefined) || (data.customer_alias == "")) missing += '<li>Customer</li>';
		if (data.OCtier1 == "- Choose One -") missing += '<li>Operational Categorization Tier 1</li>';
		if (data.OCtier2 == "- Choose One -") missing += '<li>Operational Categorization Tier 2</li>';
		if (data.product == "- Choose One -") missing += '<li>Product</li>';
		if (data.summary == "") missing += '<li>Summary</li>';
		if (data.details == "") missing += '<li>Details</li>';
		if (data.details.length > 500) missing += '<li>Details: Exceeds 500 characters</li>';
				
		if (missing == "")
		{
			$.ajax({
				url: "/createTicket",
				data: data,
				method : 'GET', 
				beforeSend: function(){
					$("#modal-container").show();
				},
				timeout: 180000, // 180s timeout
				error: function(){
			        // will fire when timeout is reached
					$("#status-box div div").addClass('alert-danger');
					$("#status-box div div").html('Ticket could not be created due a timeout error, please try again. <br>Contact the administrator if you keep getting this error.');
					
					$("#status-box").show();
					$("#modal-container").hide();
			    }
			}).done(function (data){

				if(data.status)	
				{

					//clear all form
					$('#frm-ticket').trigger("reset");
					tier1OC.val(null).trigger("change");
					tier2OC.val(null).trigger("change");
					product.val(null).trigger("change");
					clearCustomerBox();
					
					$("#status-box div div").addClass('alert-success');		
				}
				else
				{
					$("#status-box div div").addClass('alert-danger');									
				}
				
				$("#status-box div div").html(data.message);
				$("#status-box").show();
				$("#modal-container").hide();	
			});
		}
		else
		{
			$("#status-box div div").html('There is something wrong with your input, you are missing the following fields:<ul>'+missing+'</ul>');
			$("#status-box div div").addClass('alert-danger');
			$("#status-box").show();
		}
		
	})
	
	/*
	var queue = $("#drpdwn-queue").select2(
	{
		ajax: {
			placeholder: 'Enter a support queue',
		    url: '/getqueues',
		    dataType: 'json',
		    delay: 400,
		    data: function(params) {
                return {
                    term: params.term
                }
            },
            processResults: function (data, page) {
                return {
                  results: data
                };
              },
		    cache: true
		},
		escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
		minimumInputLength: 2				 
	});
	
	$("#assignqueue").click(function (){
		$("#queuesel").removeClass('hidden');
	});
	
	$("#assignme").click(function (){
		$("#queuesel").addClass('hidden');
	});
	
	$("#queuesel").addClass('hidden');
	
	*/

});//end of document ready function


/*
 * Function that fullfill the field "summary" concatenating the
 * information from other fields
 */
function updateSummary()
{		
	var tier1 = ($("#drpdwn-OCtier1 option:selected").text() != '- Choose One -')? $("#drpdwn-OCtier1 option:selected").text() : '';
	var tier2 = ($("#drpdwn-OCtier2").val() != '- Choose One -')? $("#drpdwn-OCtier2").val() : '';
	var product = ($("#drpdwn-product option:selected").text() != '- Choose One -')? $("#drpdwn-product option:selected").text() : '';
	
	var sumVal = tier1+" "+tier2+" "+product;

	$("#txt-summary").val(sumVal);
}

function clearStatusBox()
{
	$("#status-box").hide();
	$("#status-box div div").removeClass('alert-danger');
	$("#status-box div div").removeClass('alert-success');
	$("#error-box").hide();
	$("#error-box div div").html('');
}

function clearCustomerBox()
{
	if (!$("#customer-name").css('display', 'none'))
		$("#customer-name").show();
	$("#customer-name div").removeClass('alert-success');			
	$("#customer-name div").removeClass('alert-danger');
	$("#customer-name div").html('');
	$("#txt-customer").val('');
}

/*
function clearCategoryProduct()
{
	tier1OC.val(null).trigger("change");
	tier2OC.val(null).trigger("change");
	product.val(null).trigger("change");
}
*/
/*
function clearAllForm()
{
	$('#frm-ticket').trigger("reset");
	//clearCategoryProduct();
	
	tier1OC.val(null).trigger("change");
	tier2OC.val(null).trigger("change");
	product.val(null).trigger("change");
	
	clearCustomerBox();
}*/

function startForm()
{
	$('#frm-ticket').trigger("reset");
}